---
title: 那些关于“架构”的七七八八
date: 2017-05-08 10:49:10
tags:
- 架构
categories:
- 业余学习
---
# 前言
最开始听说到架构师这个词，估计还是在美剧 **How I met your Mother** 听到的，那时只觉得做建筑的人才会有 **架构师** 这么个称号，后来和同学交流得知，这个词在互联网领域很常见。
作为初入互联网的小白，收集些关于架构师的知识点，定期进行总结和复习，也为将来的工作做打算。
这里说不上技术多高精尖，更多的是需要耐心和时间，这篇文章会长期更新，也欢迎各路大神批评指正，感谢。
# 架构
具体架构师是个什么东东，我没找到什么官方的定义，在[Wiki](https://zh.wikipedia.org/wiki/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E5%B8%88)上有看到下面的定义：
```
系统架构师（System Architect，簡稱SA或SAr），是在信息系统研发中，负责依据需求来确定主要的技术选择、设计系统的主体框架结构，并负责搭建实施的人。他们（与系统分析师共同）确立系统的主体架构和实现方向，并负责指导软件工程师等开发人员的编码开发工作。
```
简而言之，架构是根据业务需求所指定的合理且可落地的技术规范。架构师，听起来就很高大上，各种引领团队方向，指导开发工作。可是要成为一个合格的架构师，首先必须是一名合格的编码人员，在各种吸星大法吸收了各路技术理念与框架后，达到一个比较牛XX能力时，能在整个项目里 **定义规范** 与 **指导落地**。
## 架构的演进历史
- 没有架构
- 水平分层架构(单块架构)
- 分布式架构
- 面向服务架构(SOA)
- 前后端分离架构
- 微服务架构
微服务架构的一些理解可以参考以前的日志
{% post_link Micro-Services 微服务学习 %}

# 到处拾到的知识点!
## 关于架构优化的一些问题收集
[《大型网站技术架构》网站的高性能架构及优化](https://my.oschina.net/u/2260265/blog/501289)
### web前端优化
减少http请求数，利用keep-alive进行连接复用
使用反向代理，CDN服务对资源进行缓存
在客户端缓存资源
传输压缩过的内容，比如nginx中的gzip功能
### 应用服务器优化
合理使用缓存
异步操作，使用消息队列进行削峰
利用负载均衡配置集群
代码优化（使用多线程，创建无状态对象，局部对象，并发访问资源使用锁，资源复用，灵活组合各种数据结构，利用垃圾回收机制）
### 大数据存储方面，mysql本身有瓶颈，一般会进行什么样的优化？
数据库读写分离，利用缓存减少对数据库读写的压力，可以利用主从数据库进行热备份，对数据库进行分库或业务拆分
### 缓存相关的
缓存的本质是一个内存hash表，存着key-value值
网络访问遵循二八定律，80%的访问20%的数据
要合理使用缓存要考虑：
1. 避免频繁修改缓存数据
2. 避免没有热点的访问
3. 要考虑数据不一致和脏读（缓存数据一般都有失效时间）
4. 缓存可用性，考虑分布式缓存
5. 缓存穿透，要考虑恶意攻击某个不存在的业务，比如可以考虑把null空值缓存
分布式缓存架构可以考虑JBoss，MemCached，Redis等

#### redis和memcahced区别
- redis除了支持key-value数据类型，还可以提供list，set，sorted set，hash等数据结构的存储
- redis支持数据的备份，即master-slave模式的数据备份
- redis支持数据的持久化，可以将内存中的数据保持在磁盘中，重启时可以再次加载

**网络IO模型**
Memcached是多线程，非阻塞IO复用的网络模型
Redis使用单线程的IO复用模型
**内存管理方面**
Memcached使用预分配的内存池的方式，会带来一定程度空间浪费
Redis使用现场申请内存的方式来存储数据，会存在一定的内存碎片
**数据一致性问题**
Memcached提供cas命令，可以保证多个并发访问操作同一份数据的一致性问题。
Redis没有cas命令，不能保证，但是Redis提供了事务的功能，可以保证一串命令的原子性，中间不会被任何操作打断
**存储方式及其他方面**
Memcached基本只支持key-value存储
Redis除了key-value外，还支持list，set，sorted 等数据结构
### 数据库优化，主要进行拆分，什么是水平拆分？什么是垂直拆分？优缺点？
1. 优化SQL和索引
2. 加缓存，比如memcached和redis
3. 主从复制，读写分离，可以在应用层做
4. 用mysql自带分区表
5. 垂直拆分，根据模块的耦合度，将一个大的系统分为多个小系统，也就是分布式系统
6. 水平拆分，针对数据量大的表，先选择一个合理的sharding key，为了有好的查询效率，表的结构也要改动，做一定的冗余，sql中尽量带sharding key，将数据定位到限定的表上去查，而不是扫描全部的表

**垂直拆分**
是指按功能模块拆分，也可以是列拆分。比如分为订单库、商品库、用户库。。。用这种方式多个数据库之间的表结构不同。
垂直拆分是实现比较简单，根据表名访问不同的数据库就可以
优点：
拆分后业务清晰，拆分明确，系统之间整合或扩展容易，数据维护简单
缺点：
部分业务无法join，只能通过接口方式解决，提高了复杂度，存在单库性能瓶颈，事务处理复杂
**水平拆分**
将同一个表的数据进行分块保存到不同的数据库中，这些数据库中的表结构完全相同。
水平拆分比较复杂，有几种前人总结的拆分规则：
1. 顺序拆分：比如可以按照订单的日期按年份来分，这样做优点是可以部分拆分，缺点是数据分布明显不均匀
2. hash取模分：比如对user_id进行hash，然后用一个特定的数字，比如要切分4个数据库，我们就可以选4，对user_id的hash值进行取模。优点是数据分布均匀，缺点是数据迁移时候麻烦，不能按照机器性能分摊数据
优点：
不存在单库大数据情况和高并发瓶颈，提高了系统的稳定性跟负载能力
缺点：
拆分规则难以抽象，分片事务一致性难以解决，数据多次扩展难度跟维护量较大，跨库join性能较差

### 数据库分片大概原理
Sharding与数据库分区（Partition）的区别

### 服务器方面的优化
可以考虑负载均衡，资源静态化，分布式集群能异步的就异步处理，后面再加消息队列
### 分布式系统的一致性问题（大白话的讲？）？主从同步的延迟如何解决，容灾如何处理？
[大白话讲分布式系统](https://waylau.com/talk-about-distributed-system/)
好的架构应该考虑不同等级的容灾。集群容灾，在集群中某一个服务节点崩溃的情况下，集群中另外一台主机能够接替马上接替他的工作，并且故障节点能够脱离；分布式容灾：分布式系统一般会假设整个系统中随时都在发生单点故障/多点故障，当产生单点故障/多点故障时，整个分布式系统都还可以正常对外提供服务，并且分布式系统中的单点故障/多点故障区可以通过自动/人工的方式进行恢复，分布式系统会重新接纳它们；异地容灾（机房等级容灾）：在机房产生物理灾难的情况下（物理网络断裂、战争摧毁、地震等），在某个相隔较远的异地，备份系统能够发现这样的灾难发生，并主动接过系统运行权，通知系统运维人员（根据系统不同的运行要求，可能还有多个备份系统）。异地容灾最大的挑战性是如何保证异地数据的完整性。
#### 主从同步延迟问题的解决方案
MySQL的主从同步
Slaver上有一个IO线程负责从Master取bin-log写到本地，另外有一个SQL线程负责执行这些本地日志relay-log实现命令重放。但是SQL线程只有一个，更新速度跟不上，就会造成主从同步延迟。
1. 读写分离，利用mySQL搭多个transfer
2. 利用MySql Proxy实现读写分离，然后在Master上增加一个自增表，这个表仅含有一个字段，当Master接收到任何数据更新的请求时，均会触发这个触发器，更新自增表中的记录。

### 灰度发布流程和原理？灰度发布可以解决什么问题，怎么构建完善的灰度发布体系？
**灰度发布** 是指在黑白之间，能够平滑过渡的一种发布方式。AB test就是一种灰度发布方式，让一部分用户继续用A，一部分用户开始用B，如果用户对B没有什么反对意见，那么逐步扩大范围，把所有用户都迁移到B上面来。这期间，通过手机这部分用户对新版本应用的显示反馈（论坛啊微博啥的）或者是隐式反馈（应用自身统计数据），对新版本应用的功能、性能、稳定性等指标进行评判，进而决定继续放大新版本投放范围直至全量升级或回滚至老版本。
**具体流程**
需求评审 - 建立试验方案 - 新功能开发 - 灰度发布 - 小流量AB测试 - 发布成功的功能，同时关闭失败的。
**灰度发布需要考虑的一些要素**
- 用户标识： IP，Cookie
- 目标用户选取策略，比如地理位置、用户终端特性（分辨率、性能）、用户自身特点（年龄，性别等），对于客户端应用，可以考虑让用户自主选择采用哪些版本
- 数据反馈，比如客户端性能、客户端稳定性、使用次数、使用频率
- 新版本公关运营支持，及时处理用户的显示反馈
关于灰度测试相关可以参考[灰度发布和A/B test](http://www.jianshu.com/p/88f206f48278)
### 架构能力方面，如何进行业务分层，代码模块化？

### 服务器的健康度，zabbix监控服务器，ZooKeeper监控软件
### 企业统计一般会统计哪些数据？通过统计一般可以找到哪些问题？可能的网络问题，业务上线问题？
### 网络安全，对外提供服务，要考虑一定的安全防护，对于sql注入，SSRF漏洞等常见漏洞
**sql注入**
1. 严格限制Web应用的数据库操作权限，限制用户权限
2. 检查输入数据是否具有所期望的数据格式，严格限制变量的类型
3. 对进入数据库的特殊字符进行转移处理或编码处理
4. 所有查询语句建议使用数据库提供的参数化查询接口
5. 正式发布前建议使用专业的SQL注入检测工具进行检测
6. 避免网站打印出SQL错误信息
**SSRF漏洞**
SSRF是一种由攻击者构造形成由服务端发起请求的一个安全漏洞，一般情况下，SSRF攻击的目标是从外网无法访问的内部系统。利用一个可以发起网络请求的服务，当作跳板来攻击其他服务。
1. 可以通过抓包分析发送的请求是否是由服务器的发送来判断是否存在SSRF漏洞
2. 在页面源码中查找访问的资源地址，比如`www.xxx.com/a.php?image=xxx`就可能存在SSRF漏洞。
```
如何防御SSRF
1. 过滤返回信息，验证远程服务器对请求的响应
2. 统一错误信息，避免用户可以根据错误信息来判断远程服务器的端口状态
3. 限制请求的端口为http常用的端口，比如，80，443，8080，8090
4. 黑名单内网ip，避免应用被用来获取内网数据，攻击内网
5. 禁用不需要的协议，仅允许http和https请求
6. 使用正则对参数进行校验，防止畸形请求绕过黑名单
```
### 业务回滚的场景和实现
在复杂的业务中，要分步处理多个小的业务。一旦业务没有全部执行通过，出错点前面业务产生的数据要回滚掉。
# Good Good Study - Day Day Up !
这里收集一些可以阅读的书籍、网站新闻和杂志，便于日后学习
1. [InfoQ架构师月刊](http://www.infoq.com/cn/architect/)
